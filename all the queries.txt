GROUP_BY = """
SELECT COUNT(id)
FROM Contract
GROUP BY bigpharma_id;
HAVING start_date < %s;
"""

GROUP_BY = """
SELECT COUNT(id)
FROM Contract
GROUP BY bigpharma_id;
HAVING end_date < %s;
"""

CREATE VIEW PatientsWithYoungDoctors AS
SELECT name FROM Patient
    WHERE age > (SELECT exp FROM Doctor WHERE Doctor.id=Patient.doctor_id);
   
CREATE VIEW DoctorsWithOldPatients AS
SELECT name FROM Doctor
    WHERE (SELECT avg(age) FROM Patient WHERE Patient.doctor_id = Doctor.id) > 50;

CREATE OR REPLACE FUNCTION before_remove_contract() RETURNS trigger AS $$
    BEGIN
        DELETE FROM Sell WHERE pharmacy_id=OLD.pharmacy_id AND drug_id = ANY(SELECT id FROM Drug WHERE bigpharma_id=OLD.bigpharma_id);
        RETURN OLD;
    END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS before_remove_contract ON Contract;
CREATE TRIGGER before_remove_contract
    BEFORE DELETE ON Contract
FOR EACH ROW EXECUTE PROCEDURE before_remove_contract();

						

--NEW--



-Ασθενης με βαση το γιατρο, το ονομα, την ηλικια, την διευθυνση και καποιο φαρμακο
	SELECT name, age, address, Doctor.name FROM Patient, Doctor 
		WHERE Patient.doctor_id = Doctor.id 
		AND id=ANY(SELECT patient_id FROM Prescription 
			WHERE drug_id = ANY(SELECT drug_id from Sell 
				WHERE pharmacy_id=%(our_pharmacy)s)) 
		AND (CASE WHEN %(include_name)s THEN name LIKE '%%%(name)s%%' ELSE true END) 
		AND (CASE WHEN %(include_exp)s THEN exp = %(exp)s ELSE true END) 
		AND (CASE WHEN %(include_maxage)s THEN age < %(maxage)s ELSE true END) 
		AND (CASE WHEN %(include_minage)s THEN age > %(minage)s ELSE true END) 
		AND (CASE WHEN %(include_doctor)s THEN doctor_id = ANY(SELECT id FROM Doctor 
			WHERE name LIKE '%%%(doctor)s%%') ELSE true END) 
		AND (CASE WHEN %(include_address)s THEN address LIKE '%%%(address)s%%' ELSE true END) 
		AND (CASE WHEN %(include_drug)s THEN id = ANY(SELECT patient_id FROM Prescription 
			WHERE drug_id = ANY(SELECT id FROM Drug 
				WHERE name LIKE '%%%(drug)s%%')) ELSE true END);

-Γιατρος με βαση το Ονομα, την ειδικοτητα, την εμπειρια, τους ασθενεις και καποιο φαρμακο
	SELECT name, specialty, exp FROM Doctor 
		WHERE id=ANY(SELECT doctor_id FROM Prescription 
			WHERE drug_id = ANY(SELECT drug_id from Sell 
				WHERE pharmacy_id=%(our_pharmacy)s)) 
		AND (CASE WHEN %(include_name)s THEN name LIKE '%%%(name)s%%' ELSE true END) 
		AND (CASE WHEN %(include_specialty)s THEN specialty LIKE '%%%(specialty)s%%' ELSE true END) 
		AND (CASE WHEN %(include_exp)s THEN exp = %(exp)s ELSE true END) 
		AND (CASE WHEN %(include_patient)s THEN id = ANY(SELECT doctor_id FROM Patient 
			WHERE name LIKE '%%%(patient)s%%') ELSE true END) 
		AND (CASE WHEN %(include_drug)s THEN id = ANY(SELECT doctor_id FROM Prescription
			WHERE drug_id = ANY(SELECT id FROM Drug 
				WHERE name LIKE '%%%(drug)s%%')) ELSE true END);

-Φαρμακευτικη με βαση το ονομα, το τηλεφωνο, καποιο φαρμακο και το ποτε ειχαμε συμβολαιο 
	SELECT name, phone FROM BigPharma 
		WHERE (CASE WHEN %(include_name)s THEN name LIKE '%%%(name)s%%' ELSE true END) 
		AND (CASE WHEN %(include_phone)s THEN phone LIKE '%%%(phone)s%%' ELSE true END) 
		AND (CASE WHEN %(include_drug)s THEN id = ANY(SELECT bigpharma_id FROM Drug 
			WHERE name LIKE '%%%(drug)s%%') ELSE true END) 
		AND (CASE WHEN %(include_contract)s THEN id = ANY(SELECT bigpharma_id FROM Contract 
			WHERE start_date > %(start-date)s 
			AND end_date < %(end-date)s) ELSE true END);

-Φαρμακο με βαση τη φαρμακευτικη, τη φορμουλα, την τιμη και το αν το πουλαμε.
	SELECT name, formula, bigpharma_id FROM Drug 
		WHERE (CASE WHEN %(include_price)s THEN (SELECT price FROM Sell 
			WHERE Sell.drug_id = Drug.id) < %(price)s ELSE true END) 
		AND (CASE WHEN %(include_name)s THEN name LIKE '%%%(name)s%%' ELSE true END) 
		AND (CASE WHEN %(include_formula)s THEN formula LIKE '%%%(formula)s%%' ELSE true END) 
		AND (CASE WHEN %(include_sell)s THEN id = ANY(SELECT drug_id FROM Sell
			WHERE pharmacy_id = ANY(SELECT id FROM Pharmacy 
				WHERE id=%(our_pharmacy)s)) ELSE true END);

-Συνταγη με βαση το γιατρο, τον ασθενη, την ημερομηνια και το φαρμακο, με τον πιο άσχημο τρόπο που μπορείς.
	SELECT Patient.name, Doctor.name, Drug.name, date, dosage FROM Patient, Doctor, Drug, (SELECT patient_id, doctor_id, drug_id, date, dosage FROM Prescription 
			WHERE (CASE WHEN %(include_doctor)s THEN doctor_id = ANY(SELECT id FROM Doctor 
				WHERE name LIKE '%%%(doctor)s%%') ELSE true END) 
			AND (CASE WHEN %(include_patient)s THEN patient_id = ANY(SELECT id FROM Patient 
				WHERE name LIKE '%%%(patient)s%%') ELSE true END) 
			AND (CASE WHEN %(include_date)s THEN date = %(date)s ELSE true END) 
			AND (CASE WHEN %(include_drug)s THEN drug_id = ANY(SELECT id FROM Drug 
				WHERE name LIKE '%%%(drug)s%%') ELSE true END)
	) AS prescription_shit 
		WHERE prescription_shit.patient_id = Patient.id 
		AND prescription_shit.doctor_id = Doctor.id
		AND prescription_shit.drug_id = Drug.id 
		AND Drug.id = ANY(SELECT drug_id FROM Sell 
			WHERE pharmacy_id = %(our_pharmacy)s);

-Ποια Φάρμακα Χρησιμοποιούνται κυρίως από γηραιότερους ασθενείς?
	SELECT name, formula FROM Drug
	    WHERE (SELECT avg(age) FROM Patient
	    	WHERE Patient.id = ANY(SELECT patient_id FROM Prescription 
			WHERE Prescription.drug_id = ANY(SELECT id FROM Drug))) > 50;

-Ποια και ποσα Φάρμακα Πουλάει το Φαρμακείο μας?
	SELECT name, formula, bigpharma_id FROM Drug 
		WHERE id = ANY(SELECT drug_id FROM Sell
			WHERE pharmacy_id = ANY(SELECT id FROM Pharmacy
				WHERE id = %(our_pharmacy)s)) 
	SELECT COUNT(id) FROM (SELECT name FROM Drug 
		WHERE Drug.id = ANY(SELECT drug_id FROM Sell 
			WHERE Sell.pharmacy_id = (SELECT id FROM Pharmacy
				WHERE id = %(our_pharmacy)s)));

-Ποιος με πηρε τηλεφωνο?
	SELECT phone FROM BigPharma, Pharmacy WHERE phone LIKE '%%%s%%';
	
-Με ποιες εταιρίες συνεργάζεται το φαρμακείο?
	SELECT name, phone FROM BigPharma 
		WHERE BigPharma.id = ANY(SELECT bigpharma_id FROM Contract 
			WHERE start_date<CURRENT_DATE 
			AND end_date>CURRENT_DATE 
			AND Contract.pharmacy_id = %(our_pharmacy)s);

-Με ποιες εταιρίες δε συνεργάζεται το Φαρμακείο?
	SELECT name, phone FROM BigPharma 
		WHERE BigPharma.id <> ALL(SELECT bigpharma_id FROM Contract 
			WHERE start_date<CURRENT_DATE 
			AND end_date>CURRENT_DATE
			AND Contract.pharmacy_id = %(our_pharmacy)s);

-Ποια Φάρμακα δεν πουλάει το Φαρμακείο μας από τις εταιρίες που συνεργαζόμαστε?
	SELECT name FROM Drug 
		WHERE id <> ALL(SELECT drug_id FROM Sell 
			WHERE pharmacy_id=%(our_pharmacy)s) 
		AND Drug.bigpharma_id = ANY(SELECT id FROM BigPharma 
			WHERE id = ANY(SELECT bigpharma_id FROM Contract 
				WHERE start_date<CURRENT_DATE 
				AND end_date>CURRENT_DATE));

-Ποια φάρμακα πουλάνε οι εταιρίες που δε συνεργάζονται με το φαρμακείο?
	SELECT name FROM Drug 
		WHERE bigpharma_id <> ALL(SELECT id FROM BigPharma 
			WHERE id = ANY(SELECT bigpharma_id FROM Contract
				WHERE start_date<CURRENT_DATE
				AND end_date>CURRENT_DATE 
				AND pharmacy_id=%(our_pharmacy)s));

-Ολα τα φαρμακα που χρειαζεται ενας συγκεκριμενος ασθενης. 
	SELECT drug_id, date, dosage FROM Prescription 
		WHERE patient_id = (SELECT id FROM Patient 
			WHERE name = %s);
